<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>busytex</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm@4.9.0/css/xterm.css" />
    <link rel="icon" type="image/png" href="logo.png" />
    <!--<link rel="preload" href="https://unpkg.com/monaco-editor@latest/min/vs/loader.js" as="script" />
    <link rel="preload" href="https://unpkg.com/monaco-editor@latest/min/vs/editor/editor.main.js" as="script" />
    <link rel="preload" href="https://unpkg.com/monaco-editor@latest/min/vs/base/worker/workerMain.js" as="script" />
    <link rel="preload" href="https://unpkg.com/monaco-editor@latest/min/vs/editor/editor.main.nls.js" as="script" />
    <link rel="preload" href="https://unpkg.com/monaco-editor@latest/min/vs/editor/editor.main.css" as="style" />
    <link rel="preload" href="https://unpkg.com/xterm@3.8.0/dist/xterm.css" as="style" />
    <link rel="preload" href="https://unpkg.com/xterm@3.8.0/dist/xterm.js" as="script" />
    <link rel="preload" href="/ui.js" as="script" />
    <link rel="preload" href="/guthub.js" as="script" />
    <link rel="preload" href="/busybox.js" as="script" />
    <link rel="preload" href="/monarch_lang.json" as="fetch" />
    <link rel="preload" href="/monarch_latex.json" as="fetch" />
    <link rel="preload" href="/monarch_bibtex.json" as="fetch" />
    <link rel="preload" href="logo.png" as="image" />
    <link rel="preload" href="logo.svg" as="image" />
    <link rel="preload" href="/dist/busybox_unstripped.js" as="script" />
    <link rel="preload" href="/dist/busytex_pipeline.js" as="script" />
    <link rel="preload" href="/dist/busytex.js" as="script" />
    <link rel="preload" href="/dist/texlive-basic.js" as="script" />
    <link rel="preload" href="/dist/busytex.wasm" as="fetch" type="application/octet-stream" />
    <link rel="preload" href="/dist/busybox_unstripped.wasm" as="fetch" type="application/octet-stream" />-->

    <style>
        body {
            height: 100vh;
            padding: 0; 
            margin: 0;
        }

        a, a:visited {
            color:blue;
        }

        .filetreedirectory {
            background-color: yellow
        }

        #fileupload {
            display: none;
        }

        #viewer {
            width: 50%;
            overflow: scroll;
        }

        #editor, #difftool {
            width: 40%; 
            border: 1px solid grey;
        }

        #filetree {
            height:100%;
            width: 10%;
        }

        #terminal {
            width: 100%; 
            height: 60%;
        }

        #status {
            width: 100%;
            height: 40%;
            padding: 5px;
            margin: 0;
            resize: none;
            box-sizing: border-box;
        }

        #current_file, #current_file_rename {
            margin-left: auto
        }

        #pdfpreview, #txtpreview {
            width: 99%;
            height: 100%;
        }

        #imgpreview {
            max-height: 100%
        }

        #gitstatus {
            height: 100%
        }
        
        summary {
            width: 95%;
        }
        
        /*figure, details, table {
            width: 95%;
            height: 95%;
        }*/
    </style>
  </head>
  <body>
    <div style="display: flex; flex-direction: row; height: 5%">
        <a style="display: contents" href="https://github.com/busytex/busytex">
            <img src="logo.svg" style="height:100%"></img>
        </a>
        <button id="man" class="busyui">Help</button>
        <button id="import_project" class="busyui">Import Project</button>
        <button id="upload" class="busyui">Upload</button>
        <button id="new_file" class="busyui">New File</button>
        <button id="new_folder" class="busyui">New Folder</button>
        <div style="display: flex; margin-left:auto">
            <input type="text" id="github_https_path" class="busyui" placeholder="GitHub https link"></input>
            <input type="text" id="github_token" class="busyui" placeholder="GitHub token" title="for private clone/push"></input>
            <button id="clone" class="busyui">Clone</button>
            <button id="pull" class="busyui">Pull</button>
            <button id="push" class="busyui">Commit &amp; Force Push</button>
            <button id="cache_tokenpurge" class="busyui">Purge Token Cache</button>
            <button id="publish" hidden class="busyui">Publish PDF</button>
            <input hidden type="text" style="width: 100px" id="github_release" class="busyui" placeholder="Publish Release Name" title="for publishing a PDF into a release"></input>
        </div>
    </div>
    <div style="display: flex; flex-direction: row; height: 5%">
        <button id="remove" class="busyui">Delete</button>
        <button id="download" class="busyui">Download Current File</button>
        <button id="download_zip" class="busyui">Download ZIP</button>
        <button id="download_targz" class="busyui">Download TAR.GZ</button>
        <button id="strip_comments" class="busyui">Strip Comments Recursively</button>
        <div style="display: flex; margin-left:auto">
            <button id="download_pdf" class="busyui">Download PDF</button>
            <button id="view_pdf" class="busyui">View PDF</button>
            <button id="view_log" class="busyui">View LOG</button>
            <button id="share" class="busyui">Share Link</button>
        </div>
    </div>
    <div style="display: flex; flex-direction: row; height: 5%">
        <button id="compile" class="busyui">Compile Project</button>
        <select id="tex_path" class="busyui">
            <option value="" selected>Choose TeX file: (none selected)</option>
        </select>
        <select id="tex_driver" class="busyui">
            <option value="" disabled>TeX pipeline:</option>
            <option value="xetex_bibtex8_dvipdfmx" selected>XeTeX + bibtex8 + dvipdfmx</option>
            <option value="pdftex_bibtex8">PdfTeX + bibtex8</option>
            <option value="luatex_bibtex8">LuaTeX + bibtex8</option>
        </select>
        <span id="verb" class="busyui"></span>
        <span id="current_file" class="busyui" title="Click to rename"></span>
        <input hidden type="text" class="busyui" id="current_file_rename" title="Press [Enter] to complete renaming"></input>
        <span id="dirty" class="busyui" hidden title="file is changed. wait for autosave">*</span>
        <select id="verbose" class="busyui" hidden>
            <option value="silent" selected="selected">Verbosity - Silent</option>
            <option value="info">Verbosity - Info</option>
            <option value="debug">Verbosity - Debug</option>
        </select>
    </div>
    <div style="display: flex; height: 70%">
      <select id="filetree" class="busyui" size="100"></select>
      <div id="editor" class="busyui"></div>
      <div id="difftool" class="busyui" hidden></div>
      <div id="viewer">
        <iframe id="pdfpreview" class="busyui"></iframe>
        <img hidden id="imgpreview" class="busyui"></img>
        <textarea hidden id="txtpreview" class="busyui"></textarea>
        <figure hidden id="gitstatus" class="busyui">
            <figcaption>$ git status</figcaption>
            <strong>Remote branch:</strong><a class="remotebranch"></a>, <strong>commit:</strong><a class="remotecommit"></a>
            <table id="gitstatusmodified">
                <thead><tr><th>path</th><th>remote</th><th>diff</th></tr></thead>
                <tbody></tbody>
            </table>
            <details>
                <summary>Not modified</summary>
                <table>
                    <thead><tr><th>path</th><th>remote</th><th>diff</th></tr></thead>
                    <tbody></tbody>
                </table>
            </details>
        </figure>
        <figure hidden id="gitpull" class="busyui">
            <figcaption>$ git pull</figcaption>
            <table id="gitpullmodified">
                <thead><tr><th>path</th><th>status</th></tr></thead>
                <tbody></tbody>
            </table>
            <details>
                <summary>Not modified</summary>
                <table>
                   <thead><tr><th>path</th><th>status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </details>
        </figure>
      </div>
    </div>
    <div style="display: flex; flex-direction: row; height: 10%">
      <div id="terminal" class="busyui" style="height:100%; width: 50%"></div>
      <textarea style="height:100%; width: 50%"
        name="status"
        id="status"
        class="busyui"
        cols="1"
        rows="1"
      ></textarea>
      <input type="file" id="fileupload" class="busyui" multiple>
    </div>


<script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>

<script type="module">

import { Shell } from '/ui.js'

class FitAddon{

  constructor() {this._terminal = undefined;}

  activate(terminal) {
    this._terminal = terminal;
  }

  dispose(){}

  fit(){
    const dims = this.proposeDimensions();
    if (!dims || !this._terminal) {
      return;
    }

    // TODO: Remove reliance on private API
    const core = (this._terminal)._core;

    // Force a full render
    if (this._terminal.rows !== dims.rows || this._terminal.cols !== dims.cols) {
      core._renderService.clear();
      this._terminal.resize(dims.cols, dims.rows);
    }
  }

  proposeDimensions(){
    if (!this._terminal) {
      return undefined;
    }

    if (!this._terminal.element || !this._terminal.element.parentElement) {
      return undefined;
    }

    // TODO: Remove reliance on private API
    const core = (this._terminal)._core;

    if (core._renderService.dimensions.actualCellWidth === 0 || core._renderService.dimensions.actualCellHeight === 0) {
      return undefined;
    }

    const parentElementStyle = window.getComputedStyle(this._terminal.element.parentElement);
    const parentElementHeight = parseInt(parentElementStyle.getPropertyValue('height'));
    const parentElementWidth = Math.max(0, parseInt(parentElementStyle.getPropertyValue('width')));
    const elementStyle = window.getComputedStyle(this._terminal.element);
    const elementPadding = {
      top: parseInt(elementStyle.getPropertyValue('padding-top')),
      bottom: parseInt(elementStyle.getPropertyValue('padding-bottom')),
      right: parseInt(elementStyle.getPropertyValue('padding-right')),
      left: parseInt(elementStyle.getPropertyValue('padding-left'))
    };
    const elementPaddingVer = elementPadding.top + elementPadding.bottom;
    const elementPaddingHor = elementPadding.right + elementPadding.left;
    const availableHeight = parentElementHeight - elementPaddingVer;
    const availableWidth = parentElementWidth - elementPaddingHor - core.viewport.scrollBarWidth;
    
    const MINIMUM_COLS = 2;
    const MINIMUM_ROWS = 1;

    const geometry = {
      cols: Math.max(MINIMUM_COLS, Math.floor(availableWidth / core._renderService.dimensions.actualCellWidth)),
      rows: Math.max(MINIMUM_ROWS, Math.floor(availableHeight / core._renderService.dimensions.actualCellHeight))
    };
    return geometry;
  }
}

const ui =
{
    ...Object.fromEntries(Array.from(document.querySelectorAll('.busyui')).map(el => [el.id, el] )),
    
    log_reset_sequence : '\x1bc',

    set_dirty(dirty)
    {
        ui.dirty.hidden = !dirty;
    },

    get_current_file : () => ui.current_file.textContent,

    isdir : option => option.className == 'filetreedirectory',
    
    get_origin : () => window.location.origin,
    
    set_current_file(basename, abspath, verb = '')
    {
        console.log('set_current_file', 'name: [', basename, ']', 'path: [', abspath, ']', 'verb: [', verb, ']');
        let span = ui.current_file, input = ui.current_file_rename;
        span.textContent = input.value = basename;
        span = ui.verb;
        span.textContent = verb;
        
        ui.filetree.selectedIndex = Array.from(ui.filetree.options).findIndex(option => option.text == basename || option.value == abspath);
    },

    toggle_current_file_rename()
    {
        let span = ui.current_file, input = ui.current_file_rename;
        [span.hidden, input.hidden] = [!span.hidden, !input.hidden];
    },

    update_tbody(tbody, st, format_path, onclick_open, onclick_diff)
    {
        tbody.innerHTML = '';
        for(const {path, status, abspath} of st)
        {
            const tr = tbody.insertRow();
            
            let tc = tr.insertCell();
            if(onclick_open)
            {
                const a = document.createElement('a');
                tc.appendChild(a);
                a.href = "#";
                a.dataset.abspath = abspath;
                a.onclick = onclick_open;
                tc = a;
            }
            tc.innerText = path;

            tc = tr.insertCell();
            if(status != 'new')
            {
                const a = document.createElement('a');
                a.innerText = 'github';
                a.target = '_blank';
                a.href = format_path(path);
                tc.appendChild(a);
            }
            
            tc = tr.insertCell();
            if(onclick_diff)
            {
                const a = document.createElement('a');
                tc.appendChild(a);
                a.href = "#";
                a.dataset.abspath = abspath;
                a.onclick = onclick_diff;
                tc = a;
            }
            tc.innerText = status;
        }
    },

    update_git_status(status, format_url, git_difftool, open)
    {
        const modified = status.files.filter(f => f.status == 'modified');
        const notmodified = status.files.filter(f => f.status == 'not modified');

        const table_modified = ui.gitstatus.querySelector('#gitstatusmodified');
        const details_notmodified = ui.gitstatus.querySelector('details');
        const tbody_modified = table_modified.querySelector('tbody');
        const tbody_notmodified = details_notmodified.querySelector('tbody');
        const a_branch = ui.gitstatus.querySelector('.remotebranch');
        const a_commit = ui.gitstatus.querySelector('.remotecommit');

        a_branch.href = format_url(status.username, status.reponame, status.gist, status.remote_branch);
        a_branch.innerText = status.remote_branch;
        
        a_commit.href = format_url(status.username, status.reponame, status.gist, status.remote_branch, status.remote_commit);
        a_commit.innerText = status.remote_commit;

        const format_path = path => format_url(status.username, status.reponame, status.gist, status.remote_branch, status.remote_commit, path);

        const onclick_diff = evt => { git_difftool(evt.target.dataset.abspath); return false; };
        const onclick_open = evt => { open(evt.target.dataset.abspath); return false; };
        
        table_modified.hidden = modified.length == 0;
        if(!table_modified.hidden)
            this.update_tbody(tbody_modified, modified, format_path, onclick_open, onclick_diff); 

        details_notmodified.hidden = notmodified.length == 0;
        if(!details_notmodified.hidden)
            this.update_tbody(tbody_notmodified, notmodified, format_path, onclick_open);
    },
    
    update_git_pull(modified, notmodified)
    {
        const table_modified = ui.gitpull.querySelector('#gitpullmodified');
        const details_notmodified = ui.gitpull.querySelector('details');
        const tbody_modified = table_modified.querySelector('tbody');
        const tbody_notmodified = details_notmodified.querySelector('tbody');

        table_modified.hidden = modified.length == 0;
        const onclick = ev => console.log(ev.target, ev.target.innerHTML) || false;
        if(!table_modified.hidden)
        {
            for(let m of modified)
                m.onclick = onclick;
            this.update_tbody(tbody_modified, modified);
        }
            
        details_notmodified.hidden = notmodified.length == 0;
        if(!details_notmodified.hidden)
            this.update_tbody(tbody_notmodified, notmodified);
    },

    update_file_tree(files, selected_file_path = null)
    {
        const select = ui.filetree;
        let i = 0, j = select.length - 1;
        for(; i < files.length; i++)
        {
            let option = select.options[i];
            if(option == null)
            {
                option = document.createElement('option');
                select.options.add(option);
            }
            option.text = files[i].name || files[i].path;
            option.value = option.title = files[i].path;
            option.selected = selected_file_path == option.value;
            option.dataset.type = files[i].contents == null ? 'd' : 'f';
            option.className = files[i].contents == null ? 'filetreedirectory' : '';
        }
        for(; j >= i; j--)
            select.options.remove(j);
    },

    update_tex_paths(files, selected_file_path = null)
    {
        
    },

    create_and_click_download_link(file_path, content, mime)
    {
        const a = document.createElement('a');
        a.download = file_path;
        a.href = URL.createObjectURL(new Blob([content], {type: mime}));
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
  
        setTimeout(() =>
        {
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }, 2000);
    },
    
    onresize()
    {
        window.busyshell.editor.layout()
        window.busyshell.terminal.fit_addon.fit()
    },

    log(text, textarea)
    {
        if(text == ui.log_reset_sequence)
            textarea.value = '';
        else
        {
            textarea.value += text + '\n';
            textarea.scrollTop = textarea.scrollHeight;
        }
    },

    log_big : text => ui.log(text, ui.txtpreview),
    
    log_small : text => ui.log(text, ui.status),

    set_route(...route_parts)
    {
        window.location.hash = route_parts.join('/');
    },

    get_route()
    {
        const hash = window.location.hash.length > 0 ? window.location.hash.substring(1) : '';
        const route_parts = hash.split('/');
        return route_parts.length > 1 ? [route_parts[0], route_parts.slice(1).join('/')] : route_parts;
    },

    toggle_editor(mode)
    {
        [ui.editor.hidden, ui.difftool.hidden] = [mode != 'editor', mode != 'difftool'];
    },

    toggle_viewer(mode, contents = '')
    {
        if(mode == 'empty')
        {
            ui.txtpreview.value = '';
            mode = 'text';
        }
        [ui.imgpreview.hidden, ui.pdfpreview.hidden, ui.txtpreview.hidden, ui.gitstatus.hidden, ui.gitpull.hidden] = [mode != 'svg' && mode != 'jpg' && mode != 'png', mode != 'pdf', mode != 'log' && mode != 'text', mode != 'gitstatus', mode != 'gitpull'];

        const b64encode = uint8array => btoa(uint8array.reduce((acc, i) => acc += String.fromCharCode.apply(null, [i]), ''));
        if(mode == 'log' || mode == 'text')
            ui.txtpreview.value = contents;
        else if(mode == 'pdf')
            ui.pdfpreview.src = URL.createObjectURL(new Blob([contents], {type: 'application/pdf'}));
        else if(mode == 'svg')
            ui.imgpreview.src = 'data:image/svg+xml;base64,' + b64encode(contents);
        else if(mode == 'png')
            ui.imgpreview.src = 'data:image/png;base64,' + b64encode(contents);
        else if(mode == 'jpg')
            ui.imgpreview.src = 'data:image/jpg;base64,' + b64encode(contents);
    }
};
  
const paths = 
{
    busytex_js : '/dist/busytex.js', 
    busytex_wasm : '/dist/busytex.wasm',
    busytex_worker_js : '/dist/busytex_worker.js', 
    busytex_pipeline_js : '/dist/busytex_pipeline.js',
    busybox_wasm : '/dist/busybox_unstripped.wasm',
    texmf_local : ['./texmf'],
    texlive_js : ['/dist/texlive-basic.js', '/dist/ubuntu-texlive-latex-recommended.js', '/dist/ubuntu-texlive-latex-extra.js', '/dist/ubuntu-texlive-science.js'],
    lang_monarch_json : './monarch_lang.json',
    latex_monarch_json : './monarch_latex.json',
    bibtex_monarch_json : './monarch_bibtex.json',
    readme_tex : '/README.tex',
    unpkg_monaco_editor : 'https://unpkg.com/monaco-editor@latest/min/vs',
    unpkg_xterm : 'https://unpkg.com/xterm@4.9.0/lib'
};

require.config({ paths: { vs: paths.unpkg_monaco_editor , xterm: paths.unpkg_xterm } });

window.MonacoEnvironment = 
{
    getWorkerUrl: function (workerId, label)
    {
        // Before loading vs/editor/editor.main, define a global MonacoEnvironment that overwrites
        // the default worker url location (used when creating WebWorkers). The problem here is that
        // HTML5 does not allow cross-domain web workers, so we need to proxy the instantiation of
        // a web worker through a same-domain script
        return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
            self.MonacoEnvironment = { baseUrl: 'https://unpkg.com/monaco-editor@latest/min/' };
            importScripts('https://unpkg.com/monaco-editor@latest/min/vs/base/worker/workerMain.js');`)}`
    }
};

function init_editor(monaco, editor_element, difftool_element, lang_monarch, latex_monarch, bibtex_monarch)
{
    // https://microsoft.github.io/monaco-editor/monarch.html
    // https://github.com/microsoft/monaco-languages/blob/master/src/python/python.ts

    // https://github.com/koka-lang/madoko/blob/master/styles/lang/latex.json
    monaco.languages.register({ id: latex_monarch.name, mimetypes : latex_monarch.mimeTypes, extensions : latex_monarch.fileExtensions});
	monaco.languages.setMonarchTokensProvider(latex_monarch.name, latex_monarch);
    monaco.languages.setLanguageConfiguration(latex_monarch.name, lang_monarch);
    
    // https://github.com/koka-lang/madoko/blob/master/styles/lang/bibtex.json
	monaco.languages.register({ id: bibtex_monarch.name, mimetypes : bibtex_monarch.mimeTypes, extensions : bibtex_monarch.fileExtensions});
	monaco.languages.setMonarchTokensProvider(bibtex_monarch.name, bibtex_monarch);
    monaco.languages.setLanguageConfiguration(bibtex_monarch.name, lang_monarch);

    return {
        editor: monaco.editor.create(editor_element, { automaticLayout: true, theme: 'vs-dark', minimap: {enabled: false } }), 
        difftool: monaco.editor.createDiffEditor(difftool_element, { automaticLayout: true })
    };
}

function init_terminal(Terminal, terminal_element, FitAddon)
{
    const terminal = new Terminal.Terminal();
    terminal.fit_addon = new FitAddon();
    terminal.loadAddon(terminal.fit_addon);

    terminal.open(ui.terminal);
    return terminal;
}

const monarch_promises = [paths.lang_monarch_json, paths.latex_monarch_json, paths.bibtex_monarch_json].map(x => fetch(x).then(r => r.json()));

const readme_tex_promise = fetch(paths.readme_tex).then(r => r.text());
const busybox_wasm_module_promise = fetch(paths.busybox_wasm).then(WebAssembly.compileStreaming);

require(['vs/editor/editor.main', 'xterm/xterm', './dist/busybox_unstripped.js'], async (Monaco, Terminal, busybox_module_constructor) =>
{
    const {editor, difftool} = init_editor(Monaco, ui.editor, ui.difftool, ...(await Promise.all(monarch_promises)));
    const terminal = init_terminal(Terminal, ui.terminal, FitAddon);
        
    window.busyshell = new Shell(monaco, ui, paths, await readme_tex_promise, terminal, editor, difftool);
    window.onresize = ui.onresize;
    window.onresize();

    await window.busyshell.run(busybox_module_constructor, busybox_wasm_module_promise);
});

</script>

</body>
</html>
